Мотивация

Яндекс метрика отображает толко посещаемость сайта, но показывает, какие проблемы есть в самой архитектруре:
 - где увеличено время выполнения запроса
 - причин долгой обработки заказа
 - какие партнеры создают такую нагрузку на сервис

Мониторинг - это система раннего оповещения. Он позволит в первую очередь своевременно уведомлять об аномальном поведение системы. 
  - Долгое выполнение запросов
  - Исполнение с ошибками
  - Неожиданная нагрузка на сеть 

Все это необходимо отслеживать, чтобы своевременно реагировать на такие события и предпринимать соответсвующие шаги

Благодаря внедрению мониторинга, в дальнейшем можно будет 
- Сократить количество заказов потерянных из-за зависаний, что является неполученной выручкой. Увеличится KPI 
- Уменьшить репутационные издержки. Можно будет возобновить работы с потерянными партнерами
- Увеличится эффективность команд. Разработчики быстро смог отреагировать на возникшие проблемы







Выбор подхода к мониторингу

USE: 
    - Быза данных: ShopDb, MESdb, 3d-files storage
    - RabbitMQ
Собираемые метрики
 - Utilization: CPU/RAM/место на диске. 
 - Saturation: Очереди к ресурсам/запросы в очереди
 - Error: Ошибки работы с диском
Причина: Позволит ответить на вопрос, а не виновато ли оборудование в возникших проблемах

Четыре золотых сигнала: 
    - Расчет цены
    - Выполнение заказа
Собираемые метрики:
    - Latency: Время выполнения заказа/ время расчета цены
    - Traffic: Количество заказов в единицу времени / количество запросов к сервису расчета цены
    - Errors: Процент заказов, которые завершились с ошибкой
    - Saturation: Количество занятых операторов / Количество потоков занятых расчетом цены
Причина: Четыре золотых сигнала позволяют отслеживать ключевые аспекты работы операторов, выполняющих заказы.

RED:
    - CRM API
    - Shop Api
    - MES API
Собираемые метрики::
 - Rate of requests: количество запросов в единицу времени. Это поможет отслеживать нагрузку на сервисы и выявлять пики активности.
 - Error rate: процент запросов, которые завершились с ошибкой.
 - Duration: время ответа
Причина: RED позволяет отслеживать актвиность сервера, частоту запросов и длительность их обработки. 
Это поможет быстро реагировать на возникающие проблемы и оптимизировать производительность сервисов.




Какие метрики будем использовать

Метрики для RED, описанные выше:
Number of requests (RPS) for internet shop API 
    Позволит определить нагрузку к АПИ, Rate Limiting
Number of requests (RPS) for CRM API
    Позволит определить нагрузку к АПИ, Rate Limiting
Number of requests (RPS) for MES API
    Позволит определить нагрузку к АПИ, Rate Limiting 
Number of requests (RPS) per user for MES API
    Позволит определить нагрузку к АПИ от конкретного партнера. И ограничить его в случае необходимости, Rate Limiting
Response time (latency) for shop API
    Отслеживание Duration для shop API, Duration
Response time (latency) for CRM API
    Отслеживание Duration для CRM API, Duration
Response time (latency) for MES API
    Отслеживание Duration для MES API, Duration
Number of HTTP 500 for shop API
    Отслеживание процент выдаваемых ошибок в shop API, Error
Number of HTTP 500 for CRM API
    Отслеживание процент выдаваемых ошибок в CRM API, Error
Number of HTTP 500 for MES API
    Отслеживание процент выдаваемых ошибок в MES API, Error

Метрики для USE, описанные выше:
Number of dead-letter-exchange letters in RabbitMQ
    Позволит отследить работы RabbitMQ, Errors в очереди 
Number of message in flight in RabbitMQ
    Позволит отследить работы RabbitMQ, Saturation в очереди
Memory Utilisation for shop db instance
    Позволит отследить работы базы данных, Utilization
Memory Utilisation for MES db instance
    Позволит отследить работы базы данных, Utilization
Number of connections for shop db instance
    Позволит отследить работы базы данных, Utilization
Number of connections for MES db instance
    Позволит отследить работы базы данных, Utilization
Size of S3 storage
    Позволит отследить работы базы данных, Saturation
Size of shop db instance
    Позволит отследить работы базы данных, Saturation
Size of MES db instance
    Позволит отследить работы базы данных, Saturation





План действий

В приоритете нужно решить проблему с заказами, которые зависают. Что является причиной потери выручки и репутационных издержек.
Для этого необходимо:
1) Внедрения мониторинга сквозных процессов по заказам. - 4 золотых сигнала
2) Отслеживать запросы от API партнеров - RED 
3) Инфрастуктура - USE для баз данных и RabbitMQ



Показатели насыщенности:
 
 - Оставшееся место на диске не должно больше 80%.
 Если упустить этот момент, то может возникать ситуация, когда сервис не сможет записать данные и начнутся сбои в работе. 
 Что приведет к потере заказов и репутационным издержкам.

 - Количество сообщений в очереди не должно превышать 1000.
 Превышение порогового значения будет свидетельствовать о том, что сервис не справляется с расчетом цен.
 Что приведет к задержкам в работах. 

- Загрузка CPU не должна превышать 80% в течение длительного времени.
 Превышение порогового значения будет свидетельствовать о том, что сервис не справляется с нагрузкой. 

 - Время расчета цены одного заказа не должно превышать 5 минут.
 Бывают случаи при работе сложных моделей, чей расчет может занять около 30 минут, но в случае повторения таких ситуаций необходимо слать уведомление и разбираться в причинах.